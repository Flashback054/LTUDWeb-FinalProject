<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#ffffff" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Display:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,300;12..96,400;12..96,500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <title>{{title}}</title>
  </head>
  <body>
    {{>layout/header}}
    <!--  -->
    {{> layout/main-nav}}
    <!--  -->
    {{{body}}}
    <!--  -->
    {{>layout/footer}}
  </body>

  <script>
    const userCartKey = "userCart";

    document.addEventListener("DOMContentLoaded", function () {
      const mainNav = document.getElementById("main-nav");
      const mainNavLinks = mainNav?.querySelectorAll("a");
      const bookSortForm = document.getElementById("book-sort-form");
      const bookPagination = document.getElementById("book-pagination");
      const categoryLinkList = document.getElementById("category-links");
      const bookPriceRangeFilter =
        document.getElementById("price-range-filter");
      const bookRatingFilter = document.getElementById("rating-filter");
      const categoryDetails = document.getElementById("category-details");
      const removeFilterButton = document.getElementById("remove-filter-btn");
      const addToCartForm = document.getElementById("add-to-cart-form");

      const userCart = JSON.parse(localStorage.getItem(userCartKey));

      const location = window.location;

      mainNavLinks?.forEach((link) => {
        if (link.getAttribute("href") === location.pathname) {
          link.classList.add("text-primary");
        } else {
          link.classList.remove("text-primary");
        }
      });

      if (bookSortForm) {
        const sortCriteria = bookSortForm.querySelector("#sort-criteria");
        const searchParams = new URLSearchParams(location.search);
        const sort = searchParams.get("sort");

        if (sort) {
          sortCriteria.value = sort;
        }

        sortCriteria.addEventListener("change", function () {
          const currentUrl = new URL(location.href);

          currentUrl.searchParams.delete("page");
          currentUrl.searchParams.delete("sort");

          if (this.value != "") {
            currentUrl.searchParams.set("sort", this.value);
          }

          window.location.href = currentUrl.href;
        });
      }

      if (bookPagination) {
        const bookNavigationLinks = bookPagination.querySelectorAll("a");
        const searchParams = new URLSearchParams(location.search);
        const page = searchParams.get("page") ? +searchParams.get("page") : 1;

        bookNavigationLinks.forEach((link) => {
          const pageNumber = +link.getAttribute("data-page");

          if (pageNumber == page) {
            link.dataset.current = "true";
          } else {
            link.dataset.current = "false";
          }
        });
      }

      if (categoryLinkList) {
        const categoryLinks = categoryLinkList.querySelectorAll("a");
        const searchParams = new URLSearchParams(location.search);
        const category = searchParams.get("category");

        categoryLinks.forEach((link) => {
          const categoryId = link.getAttribute("data-id");

          if (categoryId == category) {
            link.dataset.current = "true";
          } else {
            link.dataset.current = "false";
          }
        });
      }

      if (bookPriceRangeFilter) {
        const priceRangeInputs = bookPriceRangeFilter.querySelectorAll("input");
        const searchParams = new URLSearchParams(location.search);
        const priceRange = searchParams.get("priceRange");
        let count = 0;

        priceRangeInputs.forEach((input) => {
          const inputPriceRange = input.getAttribute("value");

          if (inputPriceRange == priceRange) {
            input.checked = true;
            count += 1;
          } else {
            input.checked = false;
          }
        });

        if (count == 0) {
          priceRangeInputs[0].checked = true;
        }

        priceRangeInputs.forEach((input) => {
          input.addEventListener("change", function () {
            const currentUrl = new URL(location.href);

            currentUrl.searchParams.delete("page");
            currentUrl.searchParams.delete("priceRange");

            if (this.checked) {
              currentUrl.searchParams.set("priceRange", this.value);
            }

            if (this.value == "all") {
              currentUrl.searchParams.delete("priceRange");
            }

            window.location.href = currentUrl.href;
          });
        });
      }

      if (bookRatingFilter) {
        const ratingInputs = bookRatingFilter.querySelectorAll("input");
        const searchParams = new URLSearchParams(location.search);
        const rating = searchParams.get("rating");
        let count = 0;

        ratingInputs.forEach((input) => {
          const inputRating = input.getAttribute("value");

          if (inputRating == rating) {
            input.checked = true;
            count += 1;
          } else {
            input.checked = false;
          }
        });

        if (count == 0) {
          ratingInputs[0].checked = true;
        }

        ratingInputs.forEach((input) => {
          input.addEventListener("change", function () {
            const currentUrl = new URL(location.href);

            currentUrl.searchParams.delete("page");
            currentUrl.searchParams.delete("rating");

            if (this.checked) {
              currentUrl.searchParams.set("rating", this.value);
            }

            if (this.value == "all") {
              currentUrl.searchParams.delete("rating");
            }

            window.location.href = currentUrl.href;
          });
        });
      }

      if (categoryDetails) {
        const searchParams = new URLSearchParams(location.search);
        const category = searchParams.get("category");

        if (category) {
          categoryDetails.open = true;
        }
      }

      if (removeFilterButton) {
        const currentUrl = new URL(location.href);

        if (
          !currentUrl.searchParams.get("priceRange") &&
          !currentUrl.searchParams.get("rating") &&
          !currentUrl.searchParams.get("category") &&
          !currentUrl.searchParams.get("q")
        ) {
          removeFilterButton.parentElement.style.display = "none";
        }

        removeFilterButton.addEventListener("click", function () {
          const currentUrl = new URL(location.href);
          const sort = currentUrl.searchParams.get("sort");

          currentUrl.search = "";

          if (sort) {
            currentUrl.searchParams.set("sort", sort);
          }

          window.location.href = currentUrl.href;
        });
      }

      if (addToCartForm) {
        const addToCartMessage = document.getElementById("add-to-cart-message");

        addToCartForm.addEventListener("submit", function (event) {
          event.preventDefault();

          const formData = new FormData(this);
          const book = Object.fromEntries(formData.entries());
          const bookId = book.id;

          if (userCart) {
            const bookIndex = userCart.findIndex((item) => {
              return item.id == bookId;
            });

            if (bookIndex == -1) {
              userCart.push(book);
            } else {
              userCart[bookIndex].quantity =
                +userCart[bookIndex].quantity + +book.quantity;
            }

            localStorage.setItem(userCartKey, JSON.stringify(userCart));
          } else {
            localStorage.setItem(userCartKey, JSON.stringify([book]));
          }

          addToCartMessage.setAttribute("aria-hidden", "false");

          setTimeout(() => {
            addToCartMessage.setAttribute("aria-hidden", "true");
          }, 3000);
        });
      }
    });
  </script>
</html>
